<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annuity Loan Structure</title>
    <style>
        /* DESIGN SYSTEM: THWS */
        :root {
            --thws-orange: #ff6a00;
            --text-dark: #333333;
            --text-light: #666666;
            --bg-white: #ffffff;
            --color-interest: #e74c3c;
            /* Red/Orange for Cost */
            --color-principal: #27ae60;
            /* Green for Equity */
            --font-stack: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            font-family: var(--font-stack);
            background-color: transparent;
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden;
            /* Prevent iframe scrolling */
        }

        .thws-card {
            border-left: 5px solid var(--thws-orange);
            background: var(--bg-white);
            padding: 20px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            height: 540px;
            /* Fits within 600px constraint */
            max-width: 800px;
            margin: 0 auto;
        }

        h2 {
            margin: 0 0 15px 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Controls Section */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
        }

        .value-display {
            color: var(--thws-orange);
            font-weight: 700;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        /* Custom Slider Styling */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #eee;
            border-radius: 3px;
        }

        input[type=range]::-webkit-slider-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--thws-orange);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            background: #fafafa;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .stat-item span {
            display: block;
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-item strong {
            font-size: 1.1rem;
            color: var(--text-dark);
        }

        /* Canvas Area */
        .canvas-container {
            flex-grow: 1;
            position: relative;
            width: 100%;
            min-height: 0;
            /* Flexbox trick */
        }

        canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.85rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        /* Tooltip */
        #tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 0.85rem;
            display: none;
            z-index: 10;
            min-width: 140px;
        }

        #tooltip div {
            margin-bottom: 4px;
        }

        #tooltip strong {
            color: var(--thws-orange);
        }

        .tt-line {
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<body>

    <div class="thws-card">
        <h2>Annuity Loan Structure <span style="font-size:0.8rem; font-weight:400; color:#666;">Annual Breakdown</span>
        </h2>

        <div class="controls">
            <div class="control-group">
                <label>Loan Amount <span class="value-display" id="val-pv">€100,000</span></label>
                <input type="range" id="input-pv" min="10000" max="1000000" step="5000" value="100000">
            </div>
            <div class="control-group">
                <label>Interest Rate (p.a.) <span class="value-display" id="val-rate">5.0%</span></label>
                <input type="range" id="input-rate" min="0.5" max="15.0" step="0.1" value="5.0">
            </div>
            <div class="control-group">
                <label>Duration <span class="value-display" id="val-years">10 Years</span></label>
                <input type="range" id="input-years" min="1" max="40" step="1" value="10">
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <span>Annual Payment (Annuity)</span>
                <strong id="stat-annuity">€12,950</strong>
            </div>
            <div class="stat-item">
                <span>Total Interest Paid</span>
                <strong id="stat-total-interest" style="color: var(--color-interest);">€29,504</strong>
            </div>
            <div class="stat-item">
                <span>Total Cost</span>
                <strong id="stat-total-cost">€129,504</strong>
            </div>
        </div>

        <div class="canvas-container" id="canvasWrapper">
            <canvas id="chartCanvas"></canvas>
            <div id="tooltip"></div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="dot" style="background: var(--color-interest);"></div>
                <span>Interest (Cost)</span>
            </div>
            <div class="legend-item">
                <div class="dot" style="background: var(--color-principal);"></div>
                <span>Principal (Repayment)</span>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const config = {
            colorInterest: '#e74c3c',
            colorPrincipal: '#27ae60',
            colorGrid: '#eeeeee',
            colorText: '#666666',
            thwsOrange: '#ff6a00'
        };

        // --- State ---
        const state = {
            pv: 100000,
            rate: 5.0,
            years: 10,
            data: [], // Stores { year, interest, principal, balance }
            annuity: 0
        };

        // --- DOM Elements ---
        const els = {
            pv: document.getElementById('input-pv'),
            rate: document.getElementById('input-rate'),
            years: document.getElementById('input-years'),
            lblPv: document.getElementById('val-pv'),
            lblRate: document.getElementById('val-rate'),
            lblYears: document.getElementById('val-years'),
            statAnnuity: document.getElementById('stat-annuity'),
            statTotalInt: document.getElementById('stat-total-interest'),
            statTotalCost: document.getElementById('stat-total-cost'),
            canvas: document.getElementById('chartCanvas'),
            wrapper: document.getElementById('canvasWrapper'),
            tooltip: document.getElementById('tooltip')
        };

        const ctx = els.canvas.getContext('2d');

        // --- Formatter ---
        const formatCurrency = (val) => {
            return new Intl.NumberFormat('en-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(val);
        };

        // --- Calculation Engine ---
        function calculate() {
            const i = state.rate / 100;
            const n = state.years;
            const pv = state.pv;

            // Annuity Formula: A = PV * (i * (1+i)^n) / ((1+i)^n - 1)
            // Check division by zero if interest is 0 (edge case)
            if (i === 0) {
                state.annuity = pv / n;
            } else {
                const factor = Math.pow(1 + i, n);
                state.annuity = pv * ((i * factor) / (factor - 1));
            }

            state.data = [];
            let balance = pv;
            let totalInterest = 0;

            for (let t = 1; t <= n; t++) {
                let interest = balance * i;
                let principal = state.annuity - interest;

                // Handle last year rounding to ensure 0 balance
                if (t === n) {
                    principal = balance;
                    // Adjust annuity slightly for the last visual bar if needed, 
                    // but mathematically we usually keep annuity constant and let the last payment vary slightly.
                    // For visualization simplicity, we treat the sum as the bar height.
                }

                balance -= principal;
                if (balance < 0) balance = 0;

                totalInterest += interest;

                state.data.push({
                    year: t,
                    interest: interest,
                    principal: principal,
                    balance: balance
                });
            }

            // Update UI Text
            els.lblPv.textContent = formatCurrency(state.pv);
            els.lblRate.textContent = state.rate.toFixed(1) + '%';
            els.lblYears.textContent = state.years + (state.years === 1 ? ' Year' : ' Years');

            els.statAnnuity.textContent = formatCurrency(state.annuity);
            els.statTotalInt.textContent = formatCurrency(totalInterest);
            els.statTotalCost.textContent = formatCurrency(state.pv + totalInterest);
        }

        // --- Rendering Engine ---
        function resizeCanvas() {
            const { width, height } = els.wrapper.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;

            els.canvas.width = width * dpr;
            els.canvas.height = height * dpr;

            ctx.scale(dpr, dpr);
            els.canvas.style.width = `${width}px`;
            els.canvas.style.height = `${height}px`;

            draw();
        }

        function draw() {
            if (!state.data.length) return;

            const width = els.canvas.clientWidth;
            const height = els.canvas.clientHeight;
            const padding = { top: 20, right: 10, bottom: 30, left: 50 };
            const chartW = width - padding.left - padding.right;
            const chartH = height - padding.top - padding.bottom;

            ctx.clearRect(0, 0, width, height);

            // Calculate Max Y (Annuity + tiny buffer)
            const maxY = state.annuity * 1.1;

            // Drawing Helper
            const getX = (index) => padding.left + (index * (chartW / state.data.length));
            const getBarWidth = () => (chartW / state.data.length) * 0.8;
            const getY = (val) => padding.top + chartH - (val / maxY * chartH);

            // Draw Axis Lines
            ctx.beginPath();
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            // Y-Axis
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, height - padding.bottom);
            // X-Axis
            ctx.lineTo(width - padding.right, height - padding.bottom);
            ctx.stroke();

            // Draw Bars
            const barW = getBarWidth();

            state.data.forEach((d, i) => {
                const x = getX(i) + (chartW / state.data.length - barW) / 2;

                // 1. Interest Bar (Bottom)
                const hInterest = (d.interest / maxY) * chartH;
                const yInterest = (padding.top + chartH) - hInterest;

                ctx.fillStyle = config.colorInterest;
                ctx.fillRect(x, yInterest, barW, hInterest);

                // 2. Principal Bar (Stacked on top)
                const hPrincipal = (d.principal / maxY) * chartH;
                const yPrincipal = yInterest - hPrincipal;

                ctx.fillStyle = config.colorPrincipal;
                ctx.fillRect(x, yPrincipal, barW, hPrincipal);
            });

            // Draw Labels (Sparse X Axis)
            ctx.fillStyle = config.colorText;
            ctx.font = '10px Inter';
            ctx.textAlign = 'center';

            // Determine label step to avoid crowding
            let step = 1;
            if (state.years > 10) step = 2;
            if (state.years > 20) step = 5;

            state.data.forEach((d, i) => {
                if (d.year === 1 || d.year === state.years || d.year % step === 0) {
                    const x = getX(i) + (chartW / state.data.length) / 2;
                    ctx.fillText(d.year, x, height - 10);
                }
            });

            // Y Axis Label (Max Value)
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.fillText(formatCurrency(state.annuity), padding.left - 5, getY(state.annuity));
            ctx.fillText("0", padding.left - 5, height - padding.bottom);
        }

        // --- Interaction ---
        function handleMouseMove(e) {
            const rect = els.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const width = els.canvas.clientWidth;
            const padding = { top: 20, right: 10, bottom: 30, left: 50 };
            const chartW = width - padding.left - padding.right;

            // Check bounds
            if (x < padding.left || x > width - padding.right || y > height - padding.bottom) {
                els.tooltip.style.display = 'none';
                return;
            }

            // Find nearest bar
            const barOuterW = chartW / state.data.length;
            const index = Math.floor((x - padding.left) / barOuterW);

            if (index >= 0 && index < state.data.length) {
                const d = state.data[index];

                // Position Tooltip
                let ttX = e.clientX - rect.left + 15;
                let ttY = e.clientY - rect.top;

                // Prevent tooltip overflow right
                if (ttX + 150 > width) ttX -= 165;

                els.tooltip.style.left = ttX + 'px';
                els.tooltip.style.top = ttY + 'px';
                els.tooltip.innerHTML = `
                <div style="border-bottom:1px solid #eee; padding-bottom:4px; margin-bottom:4px;"><strong>Year ${d.year}</strong></div>
                <div class="tt-line"><span style="color:${config.colorInterest}">Interest:</span> <span>${formatCurrency(d.interest)}</span></div>
                <div class="tt-line"><span style="color:${config.colorPrincipal}">Principal:</span> <span>${formatCurrency(d.principal)}</span></div>
                <div class="tt-line" style="margin-top:4px; font-size:0.75rem; color:#999;">Remaining: ${formatCurrency(d.balance)}</div>
            `;
                els.tooltip.style.display = 'block';
            } else {
                els.tooltip.style.display = 'none';
            }
        }

        // --- Event Listeners ---
        [els.pv, els.rate, els.years].forEach(input => {
            input.addEventListener('input', (e) => {
                // Update State
                state.pv = parseInt(els.pv.value);
                state.rate = parseFloat(els.rate.value);
                state.years = parseInt(els.years.value);

                // Recalculate & Redraw
                calculate();
                draw();
            });
        });

        els.canvas.addEventListener('mousemove', handleMouseMove);
        els.canvas.addEventListener('mouseleave', () => els.tooltip.style.display = 'none');
        window.addEventListener('resize', () => { calculate(); resizeCanvas(); });

        // --- Init ---
        calculate();
        // Wait for styles to apply before measuring canvas
        requestAnimationFrame(resizeCanvas);

    </script>
</body>

</html>